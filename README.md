# OpenNMS Minion Lab on AWS

## Overview

The repository contains an AWS CloudFormation stack and Ansible playbooks for setting up the stack and configuring the EC2 instances.

The current stack that is generated by these scripts looks like:

```
                                       - Minion 1 -                       - Elasticsearch Cluster
    Load Generator -> Load Balancer -               -> Kafka -> OpenNMS -
                                       - Minion 2 -                       - PostgreSQL
```

```
                - Kafka 1
    Zookeeper -
                - Kafka n
```

```
                             - Elasticsearch node 1
     Elasticsearch Cluster -
                             - Elasticsearch node n
```

## Requirements

* Ansible (tested with v2.2.0.0)
* Valid AWS credentials (i.e. `aws iam list-users` should run successfully)

## Lab IDs

In order to allow multiple labs to be used at the same time, we append a Lab ID to the Cloudformation stack name.
The Lab ID is also used to tag the EC2 instances.
To use a custom Lab ID, modify `vars/cf_vars.yaml` and update the `tag_LabId_jesse` portion of the commands bellow to reflect your ID.

## Setup

    ansible-playbook -vv cloudformation.yaml --tags "provision"
    ./ec2.py --refresh-cache
    ansible-playbook -i ec2.py -l tag_LabId_jesse -vv cloudformation.yaml --tags "setup" -u ec2-user

## Teardown

    ansible-playbook -vv cloudformation.yaml --tags "destroy"

## Other useful commands

    ansible-playbook -i ec2.py -l tag_LabId_jesse -vv cloudformation.yaml --tags "debug" -u ec2-user
    ansible -i ec2.py -l tag_LabId_jesse -u ec2-user tag_aws_cloudformation_stack_name_opennms_minion_lab -m ping

## Kafka and Elasticsearch

Number of Kafka and Elasticsearch nodes can be confiured in the `vars/cf_vars.yaml` configuration file.

## Using the stack

### Kafka

You can enable Kafka by appending `--extra-vars "UseKafka=true"` during the setup call.

Increase the number of partitions using:

    /opt/kafka/bin/kafka-topics.sh --zookeeper=zookeeper:2181 --alter --topic OpenNMS.Sink.Syslog --partitions 2

### Elasticsearch

List the indices and number of documents using:

    curl 'http://elasticsearch:9200/_cat/indices?v'

Cluster health:

    curl 'http://elasticsearch:9200/_cluster/health?pretty'

## References

* [AWS EC2 External Inventory Script](http://docs.ansible.com/ansible/intro_dynamic_inventory.html#example-aws-ec2-external-inventory-script)
* [Cloudformation Example]( https://github.com/ansible/ansible-examples/blob/master/language_features/cloudformation.yaml)
* [Another Cloudformation Example with linked stacks](http://odecee.com.au/cloudformation-and-ansible/)
